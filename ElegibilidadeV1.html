<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrador Ahgora - Sincroniza√ß√£o e Elegibilidade</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #eaeff2; padding: 0; margin: 0; color: #333; height: 100vh; display: flex; flex-direction: column; }
        
        /* Layout Principal */
        .main-wrapper { display: flex; flex: 1; max-width: 1400px; margin: 0 auto; width: 100%; gap: 20px; padding: 20px; box-sizing: border-box; }
        
        /* Coluna da Esquerda (Aplica√ß√£o) */
        .app-column { flex: 2; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow-y: auto; }
        
        /* Coluna da Direita (Instru√ß√µes) */
        .info-column { flex: 1; background: #f8f9fa; padding: 25px; border-radius: 8px; border: 1px solid #dee2e6; overflow-y: auto; }

        h2 { border-bottom: 3px solid #007bff; padding-bottom: 10px; color: #2c3e50; margin-top: 0; font-size: 22px; }
        h3 { font-size: 18px; color: #0056b3; margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 8px; }
        
        /* Estilos de Texto da Instru√ß√£o */
        .info-item { margin-bottom: 20px; }
        .info-label { font-weight: bold; color: #495057; display: block; margin-bottom: 5px; font-size: 14px; }
        .info-text { font-size: 13px; line-height: 1.5; color: #666; margin: 0; }
        
        .important-box { background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 15px; border-radius: 4px; margin-top: 15px; }
        .important-title { font-weight: bold; color: #856404; font-size: 13px; margin-bottom: 5px; display: block; }

        .code-snippet { background: #2d2d2d; color: #a5fb8f; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; margin-top: 5px; white-space: pre-wrap; word-break: break-all; }

        /* Formul√°rios */
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        label { font-weight: 600; display: block; margin-bottom: 5px; color: #34495e; font-size: 14px; }
        input[type="text"], input[type="date"], select { width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        
        .checkbox-group { display: flex; align-items: center; gap: 8px; margin-top: 5px; background: #f1f3f5; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .chk-label { font-weight: 500; font-size: 13px; cursor: pointer; color: #333; }

        button { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; font-size: 16px; cursor: pointer; border-radius: 5px; font-weight: bold; transition: 0.3s; margin-top: 10px; }
        button:hover { background: #2ecc71; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }

        .alert-proxy { background: #e2e3e5; color: #383d41; padding: 10px; text-align: center; border-radius: 4px; margin-bottom: 20px; font-size: 13px; border: 1px solid #d6d8db; }
        
        /* Tabela e Logs */
        .table-container { margin-top: 20px; overflow-x: auto; border: 1px solid #ddd; border-radius: 5px; max-height: 250px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #007bff; color: white; text-align: left; padding: 10px; position: sticky; top: 0; }
        td { padding: 8px 10px; border-bottom: 1px solid #eee; }
        
        textarea { width: 100%; height: 120px; font-family: 'Consolas', monospace; font-size: 11px; background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 5px; margin-top: 5px; border: none; box-sizing: border-box; }
        
        .badge { padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .badge-ok { background: #d4edda; color: #155724; }
        .badge-err { background: #f8d7da; color: #721c24; }
        
        #progressBar { width: 0%; height: 5px; background: #27ae60; transition: width 0.3s; margin-top: 10px; }

        /* Responsividade */
        @media (max-width: 900px) {
            .main-wrapper { flex-direction: column-reverse; }
            .info-column { margin-bottom: 20px; }
            body { height: auto; }
        }
    </style>
</head>
<body>

<div class="main-wrapper">
    
    <div class="app-column">
        <h2>üõ†Ô∏è Integrador e Sincronizador</h2>

        <div class="alert-proxy">
            <strong>‚ö†Ô∏è Obrigat√≥rio:</strong> Antes de enviar, ative o Proxy tempor√°rio clicando aqui: 
            <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" style="font-weight:bold; color:#0056b3;">ATIVAR CORS ANYWHERE</a>
        </div>

        <div style="margin-bottom: 15px;">
            <label>Chave da Empresa (Token Ahgora):</label>
            <input type="text" id="empresaKey" value="" placeholder="Cole a chave aqui..." required>
        </div>

        <div class="row">
            <div>
                <label>Bate Ponto (Valor Fixo):</label>
                <select id="batePonto">
                    <option value="N√£o">N√£o</option>
                    <option value="Ponto Obrigatorio">Ponto Obrigat√≥rio</option>
                </select>
            </div>
            <div>
                <label>Data Troca Elegibilidade:</label>
                <input type="date" id="dataElegibilidadeManual" value="2000-05-01">
                <div class="checkbox-group">
                    <input type="checkbox" id="chkUsaAdmissao" onchange="alternarInputData()">
                    <label for="chkUsaAdmissao" class="chk-label">
                        Usar a <b>Data de Admiss√£o</b> do CSV
                    </label>
                </div>
            </div>
        </div>

        <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; border: 2px dashed #ced4da; text-align: center; margin-bottom: 20px;">
            <label style="margin-bottom: 10px;">Selecione seu arquivo CSV:</label>
            <input type="file" id="csvFile" accept=".csv" onchange="lerCSV()">
            <small style="display:block; margin-top:5px; color:#666;">(O layout deve seguir as instru√ß√µes ao lado)</small>
        </div>

        <div id="statusProcessamento" style="display:none; margin-top:10px; background:#e8f4fd; padding:15px; border-left:4px solid #3498db;">
            <strong id="statusTexto">Aguardando...</strong>
            <div style="background:#ccc; height:5px; width:100%; margin-top:5px;"><div id="progressBar"></div></div>
        </div>

        <div id="previewArea" style="display:none;">
            <h3 style="font-size: 16px; margin-top: 20px; color: #555;">Pr√©-visualiza√ß√£o (Total: <span id="totalCount">0</span>)</h3>
            <div class="table-container">
                <table id="tabelaDados">
                    <thead>
                        <tr><th>Matr√≠cula</th><th>Nome</th><th>Adm. (XML)</th><th>Data Troca</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button id="btnEnviar" onclick="iniciarEnvioEmLotes()" disabled>Gerar XML e Enviar em Lotes</button>
        </div>

        <div class="row" style="margin-top:25px;">
            <div>
                <label>√öltimo XML:</label>
                <textarea id="xmlOutput" readonly></textarea>
            </div>
            <div>
                <label>Log de Respostas:</label>
                <textarea id="apiResponse" readonly>Aguardando envio...</textarea>
            </div>
        </div>
    </div>

    <div class="info-column">
        <h3>‚ÑπÔ∏è Instru√ß√µes e Regras</h3>

        <div class="info-item">
            <span class="info-label">üîë Chave da Empresa</span>
            <p class="info-text">
                No Ponto Eletr√¥nico, acessar <strong>Administra Empresa | Web Service</strong>. Gere a chave SOAP ou copie a chave j√° existente e cole no campo ao lado.
            </p>
        </div>

        <div class="info-item">
            <span class="info-label">üìÖ Data da Troca de Elegibilidade</span>
            <p class="info-text">
                Caso queira alterar/inserir a partir da <strong>data de admiss√£o</strong>, basta ativar a flag (checkbox) ao lado da data.
                <br><br>
                Caso queira gerar um registro com <strong>data fixa</strong> para todas as matr√≠culas constantes no arquivo CSV, desmarque a flag e informe a data manualmente.
            </p>
        </div>

        <div class="important-box">
            <span class="important-title">‚ö†Ô∏è IMPORTANTE - GOLIVE</span>
            <p class="info-text" style="color:#856404;">
                S√≥ fa√ßa esse processo considerando elegibilidade como "N√£o" para matr√≠culas que tiveram admiss√£o <strong>anterior √† data de golive</strong> caso altere a flag a partir da data de admiss√£o.
                <br><br>
                Pois os admitidos e integrados <strong>ap√≥s golive</strong> naturalmente ser√£o integrados como eleg√≠veis a partir da data de admiss√£o.
            </p>
        </div>

        <div class="info-item" style="margin-top: 20px;">
            <span class="info-label">üìÑ Layout do CSV</span>
            <p class="info-text">O layout dever√° seguir conforme o exemplo abaixo (cabe√ßalhos obrigat√≥rios):</p>
            <div class="code-snippet">Matr√≠cula;PIS;Nome;Data de Admiss√£o
1010;12345678901;Fulano;01/05/2023
1011;98765432100;Beltrano;2023-06-10</div>
        </div>

    </div>

</div>

<script>
    let dadosProcessados = [];
    const PROXY = "https://cors-anywhere.herokuapp.com/";
    const WS_URL = "https://www.ahgora.com.br/ws/pontoweb.php";
    const TAMANHO_LOTE = 1000; 

    function alternarInputData() {
        const chk = document.getElementById('chkUsaAdmissao');
        const inputData = document.getElementById('dataElegibilidadeManual');
        if (chk.checked) {
            inputData.disabled = true;
            inputData.style.backgroundColor = "#e9ecef";
        } else {
            inputData.disabled = false;
            inputData.style.backgroundColor = "#fff";
        }
        if (dadosProcessados.length > 0) exibirTabela(dadosProcessados);
    }

    function lerCSV() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return;

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            transformHeader: h => h.trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, ""),
            complete: function(results) {
                processarDadosBrutos(results.data);
            }
        });
    }

    function processarDadosBrutos(rawData) {
        dadosProcessados = [];
        rawData.forEach(row => {
            const matricula = row['matricula'] || "";
            const pis = row['pis'] || "";
            const nome = row['nome'] || "";
            const dataOriginal = row['datadeadmissao'] || row['dataadmissao'] || "";

            if (!matricula) return;

            const dataAdmissaoFormatada = formatarDataLimpa(dataOriginal);
            dadosProcessados.push({ matricula, pis, nome, dataAdmissaoXML: dataAdmissaoFormatada });
        });
        
        document.getElementById('totalCount').innerText = dadosProcessados.length;
        exibirTabela(dadosProcessados);
    }

    function formatarDataLimpa(dataStr) {
        if (!dataStr) return "";
        let limpa = dataStr.trim();
        if (limpa.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const p = limpa.split('-');
            return `${p[2]}${p[1]}${p[0]}`;
        }
        return limpa.replace(/[^0-9]/g, '');
    }

    function converterDDMMAAAAParaISO(strNumeros) {
        if (!strNumeros || strNumeros.length !== 8) return "";
        const dia = strNumeros.substring(0, 2);
        const mes = strNumeros.substring(2, 4);
        const ano = strNumeros.substring(4, 8);
        return `${ano}-${mes}-${dia}`;
    }

    function exibirTabela(dados) {
        const tbody = document.querySelector('#tabelaDados tbody');
        tbody.innerHTML = "";
        
        const amostra = dados.slice(0, 50);
        const usarAdmissao = document.getElementById('chkUsaAdmissao').checked;
        const dataManual = document.getElementById('dataElegibilidadeManual').value;

        amostra.forEach(f => {
            let dataTrocaFinal = usarAdmissao ? converterDDMMAAAAParaISO(f.dataAdmissaoXML) : dataManual;
            const statusData = f.dataAdmissaoXML.length === 8 
                ? `<span class="badge badge-ok">${f.dataAdmissaoXML}</span>` 
                : `<span class="badge badge-err">Inv√°lida</span>`;

            tbody.innerHTML += `<tr><td>${f.matricula}</td><td>${f.nome}</td><td>${statusData}</td><td>${dataTrocaFinal}</td></tr>`;
        });
        
        if (dados.length > 50) {
            tbody.innerHTML += `<tr><td colspan="4" style="text-align:center; color:#666;">... e mais ${dados.length - 50} funcion√°rios ...</td></tr>`;
        }

        document.getElementById('previewArea').style.display = 'block';
        document.getElementById('btnEnviar').disabled = (dados.length === 0);
        document.getElementById('btnEnviar').innerText = `Enviar ${dados.length} Funcion√°rios (${Math.ceil(dados.length/TAMANHO_LOTE)} lotes)`;
    }

    async function iniciarEnvioEmLotes() {
        const empresa = document.getElementById('empresaKey').value;
        const btn = document.getElementById('btnEnviar');
        const respArea = document.getElementById('apiResponse');
        const statusDiv = document.getElementById('statusProcessamento');
        const statusTxt = document.getElementById('statusTexto');
        const progressBar = document.getElementById('progressBar');

        if (!empresa) { alert("Informe a chave da empresa."); return; }

        btn.disabled = true;
        respArea.value = "Iniciando processamento em lotes...\n";
        statusDiv.style.display = 'block';

        const totalLotes = Math.ceil(dadosProcessados.length / TAMANHO_LOTE);

        for (let i = 0; i < totalLotes; i++) {
            const inicio = i * TAMANHO_LOTE;
            const fim = Math.min(inicio + TAMANHO_LOTE, dadosProcessados.length);
            const loteAtual = dadosProcessados.slice(inicio, fim);
            
            const percentual = Math.round(((i + 1) / totalLotes) * 100);
            statusTxt.innerText = `Enviando Lote ${i+1} de ${totalLotes} (Funcion√°rios ${inicio+1} at√© ${fim})...`;
            progressBar.style.width = `${percentual}%`;

            try {
                const xmlLote = gerarXMLString(loteAtual, empresa);
                document.getElementById('xmlOutput').value = xmlLote; 

                const resposta = await enviarRequisicao(xmlLote);
                const resumo = extrairResumo(resposta);
                respArea.value += `[LOTE ${i+1}/${totalLotes}]: ${resumo}\n----------------------------------\n`;
                respArea.scrollTop = respArea.scrollHeight; 

            } catch (erro) {
                respArea.value += `[ERRO LOTE ${i+1}]: ${erro.message}\n----------------------------------\n`;
                if (!confirm(`Erro no Lote ${i+1}. Deseja continuar enviando os pr√≥ximos?`)) {
                    statusTxt.innerText = "Processo interrompido pelo usu√°rio.";
                    break;
                }
            }

            if (i < totalLotes - 1) await new Promise(r => setTimeout(r, 1000));
        }

        statusTxt.innerText = "Processamento Finalizado!";
        btn.disabled = false;
        btn.innerText = "Processo Conclu√≠do";
        alert("Envio dos lotes finalizado. Verifique o log de respostas.");
    }

    function gerarXMLString(listaFuncionarios, empresa) {
        const batePonto = document.getElementById('batePonto').value;
        const usarAdmissao = document.getElementById('chkUsaAdmissao').checked;
        const dataManual = document.getElementById('dataElegibilidadeManual').value;

        let xmlItens = "";
        listaFuncionarios.forEach(f => {
            let dataTroca = usarAdmissao ? converterDDMMAAAAParaISO(f.dataAdmissaoXML) : dataManual;
            xmlItens += `
        <funcionario>
            <matricula xsi:type="xsd:string">${f.matricula}</matricula>
            <pis xsi:type="xsd:string">${f.pis}</pis>
            <nome xsi:type="xsd:string">${f.nome}</nome>
            <dataAdmissao xsi:type="xsd:string">${f.dataAdmissaoXML}</dataAdmissao>
            <bate_ponto xsi:type="xsd:string">${batePonto}</bate_ponto>
            <data_troca_elegibilidade_ponto xsi:type="xsd:string">${dataTroca}</data_troca_elegibilidade_ponto>
            <cargo xsi:type="xsd:string"></cargo>
        </funcionario>`;
        });

        return `<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ws="https://www.ahgora.com.br/ws" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
   <soapenv:Header/>
   <soapenv:Body>
      <ws:sincFuncionarios>
         <empresa xsi:type="xsd:string">${empresa}</empresa>
         <funcionarios>${xmlItens}
         </funcionarios>
      </ws:sincFuncionarios>
   </soapenv:Body>
</soapenv:Envelope>`;
    }

    async function enviarRequisicao(xml) {
        const res = await fetch(PROXY + WS_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/xml; charset=utf-8', 'X-Requested-With': 'XMLHttpRequest' },
            body: xml
        });
        if (res.status === 403) throw new Error("Proxy Bloqueado (Ative o link no topo)");
        return await res.text();
    }

    function extrairResumo(xmlStr) {
        if (xmlStr.includes("<erros>")) return "‚ö†Ô∏è ATEN√á√ÉO: Cont√©m Erros (veja detalhes no XML se necess√°rio).";
        const parser = new DOMParser();
        const doc = parser.parseFromString(xmlStr, "text/xml");
        const inseridos = doc.getElementsByTagName("inseridos")[0]?.textContent || "0";
        const alterados = doc.getElementsByTagName("alterados")[0]?.textContent || "0";
        return `Sucesso (Inseridos: ${inseridos}, Alterados: ${alterados})`;
    }
</script>

</body>
</html>